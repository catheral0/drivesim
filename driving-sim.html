<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë²„ìŠ¤ ë“œë¼ì´ë¸Œ ì‹œë®¬ë ˆì´í„°</title>
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=85da2jw89d&submodules=panorama"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --amber: #ffb300;
    --amber-dim: #7a5500;
    --dark: #0d0a05;
    --panel: rgba(20, 14, 0, 0.92);
    --red: #ff3322;
    --green: #00e676;
  }

  body {
    background: var(--dark);
    font-family: 'Orbitron', monospace;
    color: var(--amber);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  #header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 16px; background: var(--panel);
    border-bottom: 2px solid var(--amber-dim); flex-shrink: 0; z-index: 100;
  }
  #header h1 { font-size: 0.85rem; letter-spacing: 4px; color: var(--amber); text-shadow: 0 0 15px var(--amber); }
  #location-display { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: rgba(255,179,0,0.7); text-align: right; }

  #main-container { flex: 1; position: relative; overflow: hidden; }
  #roadview { width: 100%; height: 100%; background: #1a1000; }

  #pillar-left, #pillar-right {
    position: absolute; top: 0; bottom: 0; width: 20px; z-index: 8;
    background: linear-gradient(90deg, #1a1200, #2a1e00);
  }
  #pillar-left { left: 0; border-right: 2px solid #3a2800; }
  #pillar-right { right: 0; border-left: 2px solid #3a2800; }

  #status-bar {
    position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.75); border: 1px solid rgba(255,179,0,0.3);
    border-radius: 20px; padding: 4px 14px;
    font-size: 0.55rem; letter-spacing: 2px; color: rgba(255,179,0,0.8);
    z-index: 20; pointer-events: none; white-space: nowrap;
  }

  /* DASHBOARD */
  #bus-dash {
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 48%; pointer-events: none; z-index: 10;
  }
  #dash-panel {
    position: absolute; bottom: 0; left: 0; right: 0; height: 100%;
    background: linear-gradient(180deg, transparent 0%, rgba(10,7,0,0.65) 25%, #1a1200 55%, #0f0b00 100%);
    border-top: 3px solid #3a2800;
  }

  #mirror {
    position: absolute; top: -8px; left: 50%; transform: translateX(-50%);
    width: 110px; height: 32px;
    background: linear-gradient(180deg, #1a1400, #0d0a00);
    border: 2px solid #3a2800; border-radius: 0 0 55px 55px;
    display: flex; align-items: center; justify-content: center;
  }
  #mirror-text { font-size: 0.38rem; color: rgba(255,179,0,0.25); letter-spacing: 1px; }

  #speedo {
    position: absolute; left: 16px; bottom: 110px;
    width: 75px; height: 75px; border-radius: 50%;
    background: rgba(0,0,0,0.65); border: 1px solid var(--amber-dim);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 0 18px rgba(255,179,0,0.12), inset 0 0 15px rgba(0,0,0,0.5);
  }
  #speed-val { font-size: 1.3rem; font-weight: 900; color: var(--amber); text-shadow: 0 0 10px var(--amber); line-height: 1; }
  #speed-unit { font-size: 0.42rem; color: rgba(255,179,0,0.5); letter-spacing: 1px; }

  #engine-light {
    position: absolute; right: 16px; bottom: 128px;
    display: flex; flex-direction: column; align-items: center; gap: 4px;
  }
  #eng-dot {
    width: 16px; height: 16px; border-radius: 50%;
    background: #222; border: 2px solid #444; transition: all 0.3s;
  }
  #eng-dot.on { background: var(--green); border-color: var(--green); box-shadow: 0 0 14px var(--green); animation: blink 2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }
  #eng-label { font-size: 0.42rem; color: rgba(255,179,0,0.5); letter-spacing: 1px; }

  /* WHEEL AREA */
  #wheel-area {
    position: absolute; bottom: 0; left: 0; right: 0; height: 125px;
    display: flex; align-items: center; justify-content: center;
    pointer-events: all;
  }
  #left-zone { flex: 1; height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
  #right-zone { flex: 1; height: 100%; display: flex; align-items: center; justify-content: flex-start; padding-left: 8px; }
  #wheel-container { width: 150px; height: 125px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }

  #steering-wheel {
    width: 138px; height: 138px;
    position: absolute; bottom: -12px;
    transition: transform 0.25s ease;
    filter: drop-shadow(0 0 12px rgba(255,179,0,0.25));
  }

  .turn-btn {
    width: 54px; height: 54px; border-radius: 50%;
    border: 2px solid rgba(255,179,0,0.4);
    background: rgba(255,179,0,0.05);
    color: var(--amber); font-size: 1.2rem;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent; user-select: none;
    pointer-events: all;
  }
  .turn-btn:active, .turn-btn.pressed {
    background: rgba(255,179,0,0.15); border-color: var(--amber);
    box-shadow: 0 0 18px rgba(255,179,0,0.4); transform: scale(0.9);
  }
  .turn-btn:disabled { opacity: 0.2; cursor: not-allowed; transform: none !important; }

  /* INTERSECTION POPUP */
  #intersection-popup {
    display: none;
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 50;
    background: rgba(10,7,0,0.95);
    border: 2px solid var(--amber);
    border-radius: 16px;
    padding: 18px 24px;
    text-align: center;
    box-shadow: 0 0 40px rgba(255,179,0,0.3);
    pointer-events: all;
    min-width: 240px;
  }
  #intersection-popup.show { display: block; }
  #intersection-popup h3 {
    font-size: 0.7rem; letter-spacing: 3px; color: var(--amber);
    margin-bottom: 14px; text-shadow: 0 0 10px var(--amber);
  }
  #intersection-popup p {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.58rem; color: rgba(255,179,0,0.6);
    margin-bottom: 16px;
  }
  #dir-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  .dir-choice-btn {
    padding: 10px 16px; border-radius: 10px;
    border: 1px solid rgba(255,179,0,0.5);
    background: rgba(255,179,0,0.06);
    color: var(--amber); font-family: 'Orbitron', monospace;
    font-size: 0.65rem; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .dir-choice-btn:hover, .dir-choice-btn:active {
    background: rgba(255,179,0,0.18);
    border-color: var(--amber);
    box-shadow: 0 0 14px rgba(255,179,0,0.3);
  }

  /* BOTTOM CONTROLS */
  #controls {
    flex-shrink: 0; background: var(--panel);
    border-top: 2px solid var(--amber-dim);
    padding: 10px 16px; display: flex;
    align-items: center; justify-content: space-between;
    gap: 12px; z-index: 100;
  }
  #start-btn {
    flex: 1; height: 50px; border-radius: 10px;
    border: 2px solid var(--green); background: rgba(0,230,118,0.05);
    color: var(--green); font-family: 'Orbitron', monospace;
    font-size: 0.7rem; font-weight: 700; letter-spacing: 3px;
    cursor: pointer; transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  #start-btn.running { border-color: var(--red); color: var(--red); box-shadow: 0 0 14px rgba(255,51,34,0.3); }
  #map-btn {
    height: 50px; padding: 0 16px; border-radius: 10px;
    border: 2px solid rgba(255,179,0,0.5); background: rgba(255,179,0,0.05);
    color: var(--amber); font-family: 'Orbitron', monospace;
    font-size: 0.7rem; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
  }

  #main-container::after {
    content: ''; position: absolute; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.04) 3px, rgba(0,0,0,0.04) 4px);
    pointer-events: none; z-index: 5;
  }

  /* MAP MODAL */
  #map-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
  #map-modal.show { display: flex; }
  #map-panel { width: 92vw; max-width: 680px; height: 78vh; background: var(--dark); border: 2px solid var(--amber-dim); border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; }
  #map-header { padding: 12px 16px; background: var(--panel); border-bottom: 1px solid var(--amber-dim); display: flex; align-items: center; justify-content: space-between; }
  #map-header h2 { font-size: 0.75rem; letter-spacing: 3px; color: var(--amber); }
  #map-hint { font-size: 0.58rem; color: rgba(255,179,0,0.5); font-family: 'Share Tech Mono', monospace; margin-top: 2px; }
  #close-map { background: none; border: 1px solid rgba(255,51,34,0.5); color: var(--red); font-size: 1rem; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; }
  #naver-map { flex: 1; }

  #loading-screen { position: absolute; inset: 0; background: var(--dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; gap: 16px; }
  #loading-screen h2 { font-size: 0.8rem; letter-spacing: 4px; color: var(--amber); }
  .loader-bar { width: 180px; height: 2px; background: rgba(255,179,0,0.2); border-radius: 2px; overflow: hidden; }
  .loader-fill { height: 100%; background: var(--amber); box-shadow: 0 0 8px var(--amber); animation: load 2.5s ease forwards; }
  @keyframes load { from{width:0} to{width:100%} }
</style>
</head>
<body>

<div id="header">
  <h1>ğŸšŒ BUS SIM</h1>
  <div id="location-display">
    <div id="loc-name">ë™ì‘ëŒ€êµ Â· ì„œìš¸</div>
    <div id="loc-coords" style="font-size:0.6rem;opacity:0.6;">37.5102Â° N, 126.9947Â° E</div>
  </div>
</div>

<div id="main-container">
  <div id="pillar-left"></div>
  <div id="pillar-right"></div>
  <div id="roadview"></div>
  <div id="status-bar">â–  ENGINE OFF</div>

  <!-- ê°ˆë¦¼ê¸¸ ì„ íƒ íŒì—… -->
  <div id="intersection-popup">
    <h3>ğŸš¦ ê°ˆë¦¼ê¸¸</h3>
    <p>ë°©í–¥ì„ ì„ íƒí•˜ì„¸ìš”</p>
    <div id="dir-buttons"></div>
  </div>

  <div id="bus-dash">
    <div id="dash-panel">
      <div id="mirror"><span id="mirror-text">REAR VIEW</span></div>
      <div id="speedo">
        <div id="speed-val">0</div>
        <div id="speed-unit">KM/H</div>
      </div>
      <div id="engine-light">
        <div id="eng-dot"></div>
        <div id="eng-label">ENG</div>
      </div>

      <div id="wheel-area">
        <div id="left-zone">
          <button class="turn-btn" id="left-btn" disabled
            ontouchstart="startTurn('left')" ontouchend="stopTurn()"
            onmousedown="startTurn('left')" onmouseup="stopTurn()">â—€</button>
        </div>

        <div id="wheel-container">
          <svg id="steering-wheel" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="wg" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#8a6200"/>
                <stop offset="50%" style="stop-color:#ffb300;stop-opacity:0.9"/>
                <stop offset="100%" style="stop-color:#5a3c00"/>
              </linearGradient>
              <radialGradient id="hg" cx="50%" cy="40%">
                <stop offset="0%" style="stop-color:#3a2800"/>
                <stop offset="100%" style="stop-color:#1a1000"/>
              </radialGradient>
            </defs>
            <circle cx="100" cy="100" r="88" fill="none" stroke="#2a1c00" stroke-width="20"/>
            <circle cx="100" cy="100" r="88" fill="none" stroke="url(#wg)" stroke-width="12"/>
            <circle cx="100" cy="100" r="88" fill="none" stroke="rgba(255,179,0,0.15)" stroke-width="2"/>
            <circle cx="100" cy="13" r="5" fill="#5a3c00"/>
            <circle cx="15" cy="147" r="5" fill="#5a3c00"/>
            <circle cx="185" cy="147" r="5" fill="#5a3c00"/>
            <path d="M100 88 L100 18" stroke="#3a2800" stroke-width="14" stroke-linecap="round"/>
            <path d="M100 88 L100 18" stroke="#6a4800" stroke-width="9" stroke-linecap="round"/>
            <path d="M100 112 L20 155" stroke="#3a2800" stroke-width="14" stroke-linecap="round"/>
            <path d="M100 112 L20 155" stroke="#6a4800" stroke-width="9" stroke-linecap="round"/>
            <path d="M100 112 L180 155" stroke="#3a2800" stroke-width="14" stroke-linecap="round"/>
            <path d="M100 112 L180 155" stroke="#6a4800" stroke-width="9" stroke-linecap="round"/>
            <circle cx="100" cy="100" r="30" fill="url(#hg)" stroke="#5a3c00" stroke-width="3"/>
            <circle cx="100" cy="100" r="22" fill="#120e00" stroke="#3a2800" stroke-width="1.5"/>
            <circle cx="100" cy="100" r="15" fill="rgba(255,179,0,0.08)" stroke="rgba(255,179,0,0.2)" stroke-width="1"/>
            <text x="100" y="97" text-anchor="middle" fill="rgba(255,179,0,0.5)" font-size="7" font-family="Orbitron" font-weight="700">BUS</text>
            <text x="100" y="107" text-anchor="middle" fill="rgba(255,179,0,0.3)" font-size="5" font-family="Orbitron">SIM</text>
          </svg>
        </div>

        <div id="right-zone">
          <button class="turn-btn" id="right-btn" disabled
            ontouchstart="startTurn('right')" ontouchend="stopTurn()"
            onmousedown="startTurn('right')" onmouseup="stopTurn()">â–¶</button>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-screen">
    <h2>ğŸšŒ BUS SIM</h2>
    <div class="loader-bar"><div class="loader-fill"></div></div>
    <p style="font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:rgba(255,179,0,0.4);margin-top:8px;">ë™ì‘ëŒ€êµ ë¡œë“œë·° ë¡œë”© ì¤‘...</p>
  </div>
</div>

<div id="controls">
  <button id="start-btn" onclick="toggleEngine()">ì‹œë™ ON</button>
  <button id="map-btn" onclick="openMap()">ğŸ—º MAP</button>
</div>

<!-- MAP MODAL -->
<div id="map-modal">
  <div id="map-panel">
    <div id="map-header">
      <div>
        <h2>â—ˆ ìœ„ì¹˜ ì„ íƒ</h2>
        <div id="map-hint">ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ê·¸ ìœ„ì¹˜ì—ì„œ ì¶œë°œ</div>
      </div>
      <button id="close-map" onclick="closeMap()">âœ•</button>
    </div>
    <div id="naver-map"></div>
  </div>
</div>

<script>
// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx = null;
let engineOscillator = null;
let engineLfo = null;
let engineGain = null;
let engineRunning = false;

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function makeDistortionCurve(amount) {
  const samples = 256;
  const curve = new Float32Array(samples);
  for (let i = 0; i < samples; i++) {
    const x = (i * 2) / samples - 1;
    curve[i] = ((Math.PI + amount) * x) / (Math.PI + amount * Math.abs(x));
  }
  return curve;
}

function playStartSound() {
  initAudio();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const dist = audioCtx.createWaveShaper();
  dist.curve = makeDistortionCurve(120);
  osc.type = 'sawtooth';
  osc.connect(dist); dist.connect(gain); gain.connect(audioCtx.destination);
  const now = audioCtx.currentTime;
  osc.frequency.setValueAtTime(35, now);
  osc.frequency.linearRampToValueAtTime(100, now + 0.3);
  osc.frequency.linearRampToValueAtTime(50, now + 0.55);
  osc.frequency.linearRampToValueAtTime(90, now + 0.8);
  osc.frequency.linearRampToValueAtTime(55, now + 1.1);
  osc.frequency.linearRampToValueAtTime(70, now + 1.4);
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(0.4, now + 0.25);
  gain.gain.linearRampToValueAtTime(0.28, now + 1.1);
  gain.gain.linearRampToValueAtTime(0, now + 1.6);
  osc.start(now); osc.stop(now + 1.6);
  setTimeout(startEngineLoop, 1600);
}

function startEngineLoop() {
  if (engineRunning) return;
  engineRunning = true;
  initAudio();
  engineOscillator = audioCtx.createOscillator();
  engineGain = audioCtx.createGain();
  const dist = audioCtx.createWaveShaper();
  const filter = audioCtx.createBiquadFilter();
  dist.curve = makeDistortionCurve(80);
  filter.type = 'lowpass'; filter.frequency.value = 320;
  engineLfo = audioCtx.createOscillator();
  const lfoGain = audioCtx.createGain();
  engineLfo.frequency.value = 9; lfoGain.gain.value = 7;
  engineLfo.connect(lfoGain); lfoGain.connect(engineOscillator.frequency);
  engineOscillator.type = 'sawtooth';
  engineOscillator.frequency.value = 65;
  engineOscillator.connect(dist); dist.connect(filter);
  filter.connect(engineGain); engineGain.connect(audioCtx.destination);
  const now = audioCtx.currentTime;
  engineGain.gain.setValueAtTime(0, now);
  engineGain.gain.linearRampToValueAtTime(0.18, now + 0.5);
  engineOscillator.start(); engineLfo.start();
}

function setDrivingSound(isDriving) {
  if (!engineOscillator || !engineGain) return;
  const now = audioCtx.currentTime;
  if (isDriving) {
    engineOscillator.frequency.linearRampToValueAtTime(95, now + 1.0);
    engineGain.gain.linearRampToValueAtTime(0.22, now + 1.0);
  } else {
    engineOscillator.frequency.linearRampToValueAtTime(65, now + 1.0);
    engineGain.gain.linearRampToValueAtTime(0.18, now + 1.0);
  }
}

function stopEngineSound() {
  engineRunning = false;
  if (engineGain) engineGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
  setTimeout(() => {
    try { if (engineOscillator) engineOscillator.stop(); } catch(e){}
    try { if (engineLfo) engineLfo.stop(); } catch(e){}
    engineOscillator = null; engineLfo = null; engineGain = null;
  }, 600);
}

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_POS = { lat: 37.5102, lng: 126.9947 }; // ë™ì‘ëŒ€êµ
const MOVE_STEP = 0.000027;   // 1/3ë¡œ ì¤„ì„ (ê¸°ì¡´ 0.00008)
const TURN_STEP = 12;
const DRIVE_INTERVAL = 600;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let engineOn = false;
let driveTimer = null;
let turnTimer = null;
let heading = 0;
let currentPos = { ...DEFAULT_POS };
let panorama = null;
let naverMap = null;
let mapMarker = null;
let atIntersection = false;
let currentLinks = [];   // í˜„ì¬ ìœ„ì¹˜ì˜ ì—°ê²° ë°©í–¥ë“¤

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loading-screen').style.display = 'none';
    if (typeof naver !== 'undefined' && naver.maps) initRoadview();
    else setStatus('âš  API ë¡œë”© ì‹¤íŒ¨');
  }, 2700);
});

function initRoadview() {
  panorama = new naver.maps.Panorama('roadview', {
    position: new naver.maps.LatLng(currentPos.lat, currentPos.lng),
    pov: { pan: heading, tilt: 0, fov: 100 },
    logoControl: false, zoomControl: false, aroundControl: false,
  });

  // íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì™„ë£Œ ì´ë²¤íŠ¸
  naver.maps.Event.addListener(panorama, 'init', function() {
    checkIntersection();
  });

  // ìœ„ì¹˜ ë³€ê²½ë  ë•Œë§ˆë‹¤ ê°ˆë¦¼ê¸¸ ì²´í¬
  naver.maps.Event.addListener(panorama, 'position_changed', function() {
    const pos = panorama.getPosition();
    if (pos) {
      currentPos.lat = pos.lat();
      currentPos.lng = pos.lng();
      document.getElementById('loc-coords').textContent =
        `${currentPos.lat.toFixed(4)}Â° N, ${currentPos.lng.toFixed(4)}Â° E`;
    }
  });
}

// â”€â”€ ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleEngine() {
  engineOn = !engineOn;
  const btn = document.getElementById('start-btn');
  const dot = document.getElementById('eng-dot');
  const lb = document.getElementById('left-btn');
  const rb = document.getElementById('right-btn');

  if (engineOn) {
    btn.textContent = 'ì‹œë™ OFF'; btn.classList.add('running');
    dot.classList.add('on'); lb.disabled = false; rb.disabled = false;
    setStatus('â–¶ ì£¼í–‰ ì¤‘');
    document.getElementById('speed-val').textContent = 3;
    playStartSound();
    startDriving();
  } else {
    btn.textContent = 'ì‹œë™ ON'; btn.classList.remove('running');
    dot.classList.remove('on'); lb.disabled = true; rb.disabled = true;
    setStatus('â–  ENGINE OFF');
    document.getElementById('speed-val').textContent = 0;
    stopEngineSound();
    stopDriving();
    hideIntersectionPopup();
    resetWheel();
  }
}

function startDriving() {
  if (driveTimer) clearInterval(driveTimer);
  driveTimer = setInterval(moveForward, DRIVE_INTERVAL);
  setTimeout(() => setDrivingSound(true), 1700);
}

function stopDriving() {
  clearInterval(driveTimer);
  driveTimer = null;
  setDrivingSound(false);
}

// â”€â”€ MOVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function moveForward() {
  if (atIntersection) return; // ê°ˆë¦¼ê¸¸ì—ì„œ ë©ˆì¶¤

  const rad = heading * Math.PI / 180;
  currentPos.lat += MOVE_STEP * Math.cos(rad);
  currentPos.lng += MOVE_STEP * Math.sin(rad);

  if (panorama) {
    panorama.setPosition(new naver.maps.LatLng(currentPos.lat, currentPos.lng));
    panorama.setPov({ pan: heading, tilt: 0, fov: 100 });
  }

  document.getElementById('loc-coords').textContent =
    `${currentPos.lat.toFixed(4)}Â° N, ${currentPos.lng.toFixed(4)}Â° E`;

  // ê°ˆë¦¼ê¸¸ ì²´í¬ (ë§¤ 3ìŠ¤í…ë§ˆë‹¤)
  checkIntersection();
}

// â”€â”€ INTERSECTION DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkIntersection() {
  if (!panorama || !engineOn) return;

  try {
    // ë„¤ì´ë²„ íŒŒë…¸ë¼ë§ˆì˜ ì£¼ë³€ ë§í¬(ì—°ê²° ë°©í–¥) ê°€ì ¸ì˜¤ê¸°
    const pano = panorama.getPanorama();
    if (!pano) return;

    const links = pano.links || [];
    currentLinks = links;

    // ë§í¬ê°€ 2ê°œ ì´ìƒì´ë©´ ê°ˆë¦¼ê¸¸
    if (links.length >= 2) {
      handleIntersection(links);
    }
  } catch(e) {
    // ë§í¬ ì •ë³´ ì—†ì„ ë•Œ ë¬´ì‹œ
  }
}

function handleIntersection(links) {
  if (atIntersection) return; // ì´ë¯¸ íŒì—… ì¤‘

  atIntersection = true;
  document.getElementById('speed-val').textContent = 0;
  setStatus('ğŸš¦ ê°ˆë¦¼ê¸¸ - ë°©í–¥ ì„ íƒ');

  // ê° ë§í¬ì˜ ë°©í–¥ì„ í˜„ì¬ heading ê¸°ì¤€ìœ¼ë¡œ ìƒëŒ€ ë°©í–¥ ê³„ì‚°
  const dirBtns = document.getElementById('dir-buttons');
  dirBtns.innerHTML = '';

  // ë°©í–¥ ì´ë¦„ ë§¤í•‘
  const getRelDir = (linkPan) => {
    let diff = ((linkPan - heading) + 360) % 360;
    if (diff > 180) diff -= 360;
    if (diff < -60) return 'â† ì¢ŒíšŒì „';
    if (diff > 60)  return 'â†’ ìš°íšŒì „';
    return 'â†‘ ì§ì§„';
  };

  // ì¤‘ë³µ ë°©í–¥ ì œê±°
  const seen = new Set();
  links.forEach((link) => {
    const label = getRelDir(link.panoramaId ? (link.angle || 0) : (link.pan || 0));
    const pan = link.angle !== undefined ? link.angle : (link.pan || 0);
    const key = Math.round(pan / 30); // 30ë„ ë‹¨ìœ„ë¡œ ë¬¶ì–´ ì¤‘ë³µ ì œê±°
    if (seen.has(key)) return;
    seen.add(key);

    const btn = document.createElement('button');
    btn.className = 'dir-choice-btn';
    btn.textContent = label;
    btn.onclick = () => chooseDirection(pan);
    dirBtns.appendChild(btn);
  });

  // ë²„íŠ¼ì´ 1ê°œë°–ì— ì—†ìœ¼ë©´ ê°ˆë¦¼ê¸¸ ì•„ë‹˜ â†’ ê³„ì† ì£¼í–‰
  if (dirBtns.children.length <= 1) {
    atIntersection = false;
    hideIntersectionPopup();
    return;
  }

  showIntersectionPopup();
}

function chooseDirection(pan) {
  heading = (pan + 360) % 360;
  atIntersection = false;
  hideIntersectionPopup();
  setStatus('â–¶ ì£¼í–‰ ì¤‘');
  document.getElementById('speed-val').textContent = 3;

  if (panorama) {
    panorama.setPov({ pan: heading, tilt: 0, fov: 100 });
  }
  resetWheel();
  // ì•½ê°„ ë”œë ˆì´ í›„ ì¬ì¶œë°œ
  setTimeout(() => {
    if (engineOn && !atIntersection) moveForward();
  }, 400);
}

function showIntersectionPopup() {
  document.getElementById('intersection-popup').classList.add('show');
}
function hideIntersectionPopup() {
  document.getElementById('intersection-popup').classList.remove('show');
}

// â”€â”€ STEERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTurn(dir) {
  if (!engineOn) return;
  doTurn(dir);
  turnTimer = setInterval(() => doTurn(dir), 200);
}

function stopTurn() {
  clearInterval(turnTimer); turnTimer = null;
  resetWheel();
}

function doTurn(dir) {
  heading = (heading + (dir === 'left' ? -TURN_STEP : TURN_STEP) + 360) % 360;
  document.getElementById('steering-wheel').style.transform =
    `rotate(${dir === 'left' ? -38 : 38}deg)`;
  if (panorama) panorama.setPov({ pan: heading, tilt: 0, fov: 100 });
}

function resetWheel() {
  document.getElementById('steering-wheel').style.transform = 'rotate(0deg)';
}

// â”€â”€ MAP (ìˆ˜ì •: ë¨¼ì € ì§€ë„ ì´ˆê¸°í™” í›„ ì—´ê¸°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMap() {
  const modal = document.getElementById('map-modal');
  modal.classList.add('show');

  // ì§€ë„ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±, ìˆìœ¼ë©´ resize ì´ë²¤íŠ¸ ë°œìƒ
  if (!naverMap) {
    // ëª¨ë‹¬ì´ ë Œë”ë§ëœ í›„ ì§€ë„ ìƒì„± (íƒ€ì´ë° ì¤‘ìš”)
    setTimeout(() => {
      try {
        naverMap = new naver.maps.Map('naver-map', {
          center: new naver.maps.LatLng(currentPos.lat, currentPos.lng),
          zoom: 15,
          mapTypeId: naver.maps.MapTypeId.NORMAL,
        });
        mapMarker = new naver.maps.Marker({
          position: new naver.maps.LatLng(currentPos.lat, currentPos.lng),
          map: naverMap,
        });
        naver.maps.Event.addListener(naverMap, 'click', function(e) {
          const pos = e.coord;
          mapMarker.setPosition(pos);
          teleportTo(pos.lat(), pos.lng());
          closeMap();
        });
      } catch(e) {
        alert('ì§€ë„ ë¡œë”© ì‹¤íŒ¨: ' + e.message);
      }
    }, 150);
  } else {
    // ê¸°ì¡´ ì§€ë„ ì¤‘ì‹¬ ì´ë™ + ë¦¬ì‚¬ì´ì¦ˆ
    setTimeout(() => {
      naver.maps.Event.trigger(naverMap, 'resize');
      naverMap.setCenter(new naver.maps.LatLng(currentPos.lat, currentPos.lng));
    }, 100);
  }
}

function closeMap() {
  document.getElementById('map-modal').classList.remove('show');
}

function teleportTo(lat, lng) {
  currentPos = { lat, lng };
  heading = 0;
  atIntersection = false;
  hideIntersectionPopup();
  resetWheel();
  document.getElementById('loc-name').textContent = `${lat.toFixed(4)}Â°N, ${lng.toFixed(4)}Â°E`;
  document.getElementById('loc-coords').textContent = `${lat.toFixed(4)}Â° N, ${lng.toFixed(4)}Â° E`;
  if (panorama) {
    panorama.setPosition(new naver.maps.LatLng(lat, lng));
    panorama.setPov({ pan: 0, tilt: 0, fov: 100 });
  }
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg) {
  document.getElementById('status-bar').textContent = msg;
}

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') startTurn('left');
  if (e.key === 'ArrowRight') startTurn('right');
  if (e.key === ' ') { e.preventDefault(); toggleEngine(); }
  if (e.key === 'm' || e.key === 'M') openMap();
});
document.addEventListener('keyup', (e) => {
  if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') stopTurn();
});
</script>
</body>
</html>
