<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë²„ìŠ¤ ë“œë¼ì´ë¸Œ ì‹œë®¬ë ˆì´í„°</title>
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=85da2jw89d&submodules=panorama"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  :root {
    --amber:#ffb300; --amber-dim:#7a5500;
    --dark:#0d0a05; --panel:rgba(20,14,0,0.92);
    --red:#ff3322; --green:#00e676;
  }
  body { background:var(--dark); font-family:'Orbitron',monospace; color:var(--amber); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

  /* â”€â”€ TOP CONTROLS (ì‹œë™+ë§µ ìƒë‹¨ìœ¼ë¡œ) â”€â”€ */
  #top-controls {
    flex-shrink:0; background:var(--panel);
    border-bottom:none;
    padding:8px 16px; display:flex;
    align-items:center; gap:10px; z-index:100;
  }
  #header-info { flex:1; }
  #header-info h1 { font-size:0.75rem; letter-spacing:3px; color:var(--amber); text-shadow:0 0 12px var(--amber); }
  #loc-name { font-family:'Share Tech Mono',monospace; font-size:0.6rem; color:rgba(255,179,0,0.6); margin-top:1px; }
  #start-btn {
    height:44px; padding:0 16px; border-radius:10px;
    border:2px solid var(--green); background:rgba(0,230,118,0.05);
    color:var(--green); font-family:'Orbitron',monospace;
    font-size:0.65rem; font-weight:700; letter-spacing:2px;
    cursor:pointer; flex-shrink:0;
    -webkit-tap-highlight-color:transparent;
  }
  #start-btn.running { border-color:var(--red); color:var(--red); box-shadow:0 0 12px rgba(255,51,34,0.3); }
  #map-btn {
    height:44px; padding:0 14px; border-radius:10px;
    border:2px solid rgba(255,179,0,0.5); background:rgba(255,179,0,0.05);
    color:var(--amber); font-family:'Orbitron',monospace;
    font-size:0.65rem; font-weight:700; letter-spacing:2px;
    cursor:pointer; flex-shrink:0;
    -webkit-tap-highlight-color:transparent;
  }

  /* â”€â”€ MAIN VIEW â”€â”€ */
  #main-container { flex:1; position:relative; overflow:hidden; }
  #roadview { width:100%; height:100%; background:#1a1000; }

  /* Aí•„ëŸ¬ */
  #pillar-left, #pillar-right {
    position:absolute; top:0; bottom:0; width:18px; z-index:8;
    background:linear-gradient(90deg,#1a1200,#2a1e00);
  }
  #pillar-left { left:0; border-right:2px solid #3a2800; }
  #pillar-right { right:0; border-left:2px solid #3a2800; }

  /* ìƒíƒœë°” */
  #status-bar {
    position:absolute; top:8px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,0.75); border:1px solid rgba(255,179,0,0.3);
    border-radius:20px; padding:4px 14px;
    font-size:0.5rem; letter-spacing:2px; color:rgba(255,179,0,0.8);
    z-index:20; pointer-events:none; white-space:nowrap;
  }

  /* â”€â”€ ê°ˆë¦¼ê¸¸ íŒì—… â”€â”€ */
  #intersection-popup {
    display:none; position:absolute;
    top:30%; left:50%; transform:translateX(-50%);
    z-index:50; background:rgba(10,7,0,0.96);
    border:2px solid var(--amber); border-radius:14px;
    padding:16px 20px; text-align:center;
    box-shadow:0 0 40px rgba(255,179,0,0.3);
    pointer-events:all; min-width:220px;
  }
  #intersection-popup.show { display:block; }
  #intersection-popup h3 { font-size:0.65rem; letter-spacing:3px; color:var(--amber); margin-bottom:8px; }
  #intersection-popup p { font-family:'Share Tech Mono',monospace; font-size:0.52rem; color:rgba(255,179,0,0.5); margin-bottom:6px; }
  #countdown-bar-wrap { height:4px; background:rgba(255,179,0,0.15); border-radius:2px; margin-bottom:12px; overflow:hidden; }
  #countdown-bar { height:100%; background:var(--amber); border-radius:2px; width:100%; transition:width linear; }
  #dir-buttons { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  .dir-choice-btn {
    padding:10px 14px; border-radius:10px;
    border:1px solid rgba(255,179,0,0.5); background:rgba(255,179,0,0.06);
    color:var(--amber); font-family:'Orbitron',monospace;
    font-size:0.62rem; font-weight:700; letter-spacing:1px;
    cursor:pointer; transition:all 0.15s;
    -webkit-tap-highlight-color:transparent;
  }
  .dir-choice-btn:active { background:rgba(255,179,0,0.2); border-color:var(--amber); box-shadow:0 0 12px rgba(255,179,0,0.3); }

  /* â”€â”€ ëŒ€ì‹œë³´ë“œ â”€â”€ */
  #bus-dash {
    position:absolute; bottom:0; left:0; right:0;
    height:38%; pointer-events:none; z-index:10; border:none;
  }
  #dash-panel {
    position:absolute; bottom:0; left:0; right:0; height:100%;
    background:linear-gradient(180deg,transparent 0%,rgba(10,7,0,0.55) 30%,#1a1200 60%,#0f0b00 100%);
    border:none; outline:none;
  }

  /* ì—”ì§„ í‘œì‹œë“± */
  #engine-light {
    position:absolute; right:14px; bottom:90px;
    display:flex; flex-direction:column; align-items:center; gap:3px;
  }
  #eng-dot { width:14px; height:14px; border-radius:50%; background:#222; border:2px solid #444; transition:all 0.3s; }
  #eng-dot.on { background:var(--green); border-color:var(--green); box-shadow:0 0 12px var(--green); animation:blink 2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }
  #eng-label { font-size:0.38rem; color:rgba(255,179,0,0.4); letter-spacing:1px; }

  /* â”€â”€ í•¸ë“¤ ì˜ì—­ (í¬ê¸° ì¤„ì„) â”€â”€ */
  #wheel-area {
    position:absolute; bottom:0; left:0; right:0; height:105px;
    display:flex; align-items:center; justify-content:center;
    pointer-events:all;
  }
  #left-zone { flex:1; height:100%; display:flex; align-items:center; justify-content:flex-end; padding-right:10px; }
  #right-zone { flex:1; height:100%; display:flex; align-items:center; justify-content:flex-start; padding-left:10px; }
  #wheel-container { width:110px; height:105px; display:flex; align-items:center; justify-content:center; position:relative; flex-shrink:0; }

  #steering-wheel {
    width:105px; height:105px;
    position:absolute; bottom:-8px;
    transition:transform 0.25s ease;
    filter:drop-shadow(0 0 10px rgba(255,179,0,0.2));
    cursor:pointer;
  }

  .turn-btn {
    width:50px; height:50px; border-radius:50%;
    border:2px solid rgba(255,179,0,0.4); background:rgba(255,179,0,0.05);
    color:var(--amber); font-size:1.1rem;
    cursor:pointer; transition:all 0.15s;
    display:flex; align-items:center; justify-content:center;
    -webkit-tap-highlight-color:transparent; user-select:none;
    pointer-events:all;
  }
  .turn-btn:active { background:rgba(255,179,0,0.15); border-color:var(--amber); box-shadow:0 0 16px rgba(255,179,0,0.4); transform:scale(0.9); }
  .turn-btn:disabled { opacity:0.2; cursor:not-allowed; transform:none !important; }

  /* MAP MODAL */
  #map-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; }
  #map-modal.show { display:flex; }
  #map-panel { width:92vw; max-width:680px; height:78vh; background:var(--dark); border:2px solid var(--amber-dim); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
  #map-header { padding:10px 14px; background:var(--panel); border-bottom:1px solid var(--amber-dim); display:flex; align-items:center; justify-content:space-between; }
  #map-header h2 { font-size:0.7rem; letter-spacing:3px; color:var(--amber); }
  #map-hint { font-size:0.55rem; color:rgba(255,179,0,0.5); font-family:'Share Tech Mono',monospace; margin-top:2px; }
  #close-map { background:none; border:1px solid rgba(255,51,34,0.5); color:var(--red); font-size:1rem; width:30px; height:30px; border-radius:6px; cursor:pointer; }
  #naver-map { flex:1; }

  /* LOADING */
  #loading-screen { position:absolute; inset:0; background:var(--dark); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:200; gap:14px; }
  #loading-screen h2 { font-size:0.8rem; letter-spacing:4px; color:var(--amber); }
  .loader-bar { width:160px; height:2px; background:rgba(255,179,0,0.2); border-radius:2px; overflow:hidden; }
  .loader-fill { height:100%; background:var(--amber); box-shadow:0 0 8px var(--amber); animation:load 2.5s ease forwards; }
  @keyframes load { from{width:0} to{width:100%} }

  /* ë„¤ì´ë²„ ë¡œë“œë·° ë‚´ë¶€ UI ì™„ì „ ì œê±° */
  #roadview * { border:none !important; outline:none !important; }
  #roadview img { border:none !important; }
  .naver-roadview-control { display:none !important; }
  /* í˜¹ì‹œ ë‚¨ì€ ê°€ë¡œì„  ì „ë¶€ ì œê±° */
  #bus-dash, #dash-panel, #wheel-area, #top-controls { border:none !important; outline:none !important; }
</style>
</head>
<body>

<!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ (ì‹œë™+ë§µ) -->
<div id="top-controls">
  <div id="header-info">
    <h1>ğŸšŒ BUS SIM</h1>
    <div id="loc-name">ë‚´ë°©ì—­ ì‚¬ê±°ë¦¬ Â· ì„œìš¸</div>
  </div>
  <button id="start-btn" onclick="toggleEngine()">ì‹œë™ ON</button>
  <button id="map-btn" onclick="openMap()">ğŸ—º MAP</button>
</div>

<!-- ë©”ì¸ ë·° -->
<div id="main-container">
  <div id="pillar-left"></div>
  <div id="pillar-right"></div>
  <div id="roadview"></div>
  <div id="status-bar">â–  ENGINE OFF</div>

  <!-- ê°ˆë¦¼ê¸¸ íŒì—… -->
  <div id="intersection-popup">
    <h3>ğŸš¦ ê°ˆë¦¼ê¸¸</h3>
    <p>í•¸ë“¤ â—€ ì¢Œ / â–¶ ìš° â†’ ì§ì§„ ìë™</p>
    <div id="countdown-bar-wrap"><div id="countdown-bar"></div></div>
    <div id="dir-buttons"></div>
  </div>

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <div id="bus-dash">
    <div id="dash-panel">
      <div id="engine-light">
        <div id="eng-dot"></div>
        <div id="eng-label">ENG</div>
      </div>

      <!-- í•¸ë“¤ + ë°©í–¥ë²„íŠ¼ -->
      <div id="wheel-area">
        <div id="left-zone">
          <button class="turn-btn" id="left-btn" disabled
            ontouchstart="onLeftPress()" ontouchend="onLeftRelease()"
            onmousedown="onLeftPress()" onmouseup="onLeftRelease()">â—€</button>
        </div>

        <div id="wheel-container">
          <svg id="steering-wheel" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" onclick="playHorn()">
            <defs>
              <linearGradient id="wg" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#8a6200"/>
                <stop offset="50%" style="stop-color:#ffb300;stop-opacity:0.9"/>
                <stop offset="100%" style="stop-color:#5a3c00"/>
              </linearGradient>
              <radialGradient id="hg" cx="50%" cy="40%">
                <stop offset="0%" style="stop-color:#3a2800"/>
                <stop offset="100%" style="stop-color:#1a1000"/>
              </radialGradient>
            </defs>
            <circle cx="100" cy="100" r="88" fill="none" stroke="#2a1c00" stroke-width="20"/>
            <circle cx="100" cy="100" r="88" fill="none" stroke="url(#wg)" stroke-width="12"/>
            <circle cx="100" cy="100" r="88" fill="none" stroke="rgba(255,179,0,0.15)" stroke-width="2"/>
            <circle cx="100" cy="13" r="5" fill="#5a3c00"/>
            <circle cx="15" cy="147" r="5" fill="#5a3c00"/>
            <circle cx="185" cy="147" r="5" fill="#5a3c00"/>
            <path d="M100 88 L100 18" stroke="#3a2800" stroke-width="14" stroke-linecap="round"/>
            <path d="M100 88 L100 18" stroke="#6a4800" stroke-width="9" stroke-linecap="round"/>
            <path d="M100 112 L20 155" stroke="#3a2800" stroke-width="14" stroke-linecap="round"/>
            <path d="M100 112 L20 155" stroke="#6a4800" stroke-width="9" stroke-linecap="round"/>
            <path d="M100 112 L180 155" stroke="#3a2800" stroke-width="14" stroke-linecap="round"/>
            <path d="M100 112 L180 155" stroke="#6a4800" stroke-width="9" stroke-linecap="round"/>
            <circle cx="100" cy="100" r="30" fill="url(#hg)" stroke="#5a3c00" stroke-width="3"/>
            <circle cx="100" cy="100" r="22" fill="#120e00" stroke="#3a2800" stroke-width="1.5"/>
            <circle cx="100" cy="100" r="15" fill="rgba(255,179,0,0.08)" stroke="rgba(255,179,0,0.2)" stroke-width="1"/>
            <text x="100" y="97" text-anchor="middle" fill="rgba(255,179,0,0.5)" font-size="7" font-family="Orbitron" font-weight="700">BUS</text>
            <text x="100" y="107" text-anchor="middle" fill="rgba(255,179,0,0.3)" font-size="5" font-family="Orbitron">SIM</text>
          </svg>
        </div>

        <div id="right-zone">
          <button class="turn-btn" id="right-btn" disabled
            ontouchstart="onRightPress()" ontouchend="onRightRelease()"
            onmousedown="onRightPress()" onmouseup="onRightRelease()">â–¶</button>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-screen">
    <h2>ğŸšŒ BUS SIM</h2>
    <div class="loader-bar"><div class="loader-fill"></div></div>
    <p style="font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:rgba(255,179,0,0.4);margin-top:8px;">ë‚´ë°©ì—­ ì‚¬ê±°ë¦¬ ë¡œë”© ì¤‘...</p>
  </div>
</div>

<!-- MAP MODAL -->
<div id="map-modal">
  <div id="map-panel">
    <div id="map-header">
      <div>
        <h2>â—ˆ ìœ„ì¹˜ ì„ íƒ</h2>
        <div id="map-hint">ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ê·¸ ìœ„ì¹˜ì—ì„œ ì¶œë°œ</div>
      </div>
      <button id="close-map" onclick="closeMap()">âœ•</button>
    </div>
    <div id="naver-map"></div>
  </div>
</div>

<script>
// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx = null;
function getCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function makeCurve(amount) {
  const n=512, c=new Float32Array(n);
  for(let i=0;i<n;i++){const x=(i*2)/n-1;c[i]=((Math.PI+amount)*x)/(Math.PI+amount*Math.abs(x));}
  return c;
}
// í´ë½ì…˜ D: ì—ì–´í˜¼
function playHorn() {
  const ctx=getCtx(), now=ctx.currentTime;
  const o1=ctx.createOscillator(),o2=ctx.createOscillator(),o3=ctx.createOscillator();
  const gain=ctx.createGain(), filter=ctx.createBiquadFilter();
  filter.type='bandpass'; filter.frequency.value=250; filter.Q.value=2;
  o1.type='sawtooth'; o2.type='sawtooth'; o3.type='square';
  o1.frequency.value=155; o2.frequency.value=195; o3.frequency.value=130;
  o1.connect(filter); o2.connect(filter); o3.connect(filter);
  filter.connect(gain); gain.connect(ctx.destination);
  gain.gain.setValueAtTime(0,now);
  gain.gain.linearRampToValueAtTime(0.6,now+0.08);
  gain.gain.setValueAtTime(0.6,now+1.5);
  gain.gain.linearRampToValueAtTime(0,now+2.0);
  o1.start(now);o2.start(now);o3.start(now);
  o1.stop(now+2.0);o2.stop(now+2.0);o3.stop(now+2.0);
}

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_POS = { lat:37.4875, lng:126.9822 }; // ë‚´ë°©ì—­ ì‚¬ê±°ë¦¬
const MOVE_STEP   = 0.0000378;
const TURN_STEP   = 12;
const DRIVE_INTERVAL = 600;
const INTERSECTION_TIMEOUT = 500; // 0.5ì´ˆ í›„ ì§ì§„

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let engineOn=false, driveTimer=null, turnTimer=null;
let heading=0, currentPos={...DEFAULT_POS};
let panorama=null, naverMap=null, mapMarker=null;
let atIntersection=false, intersectionTimer=null;
let intersectionLinks=[];

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', ()=>{
  setTimeout(()=>{
    document.getElementById('loading-screen').style.display='none';
    if(typeof naver!=='undefined'&&naver.maps) initRoadview();
    else setStatus('âš  API ë¡œë”© ì‹¤íŒ¨');
  },2700);
});

function initRoadview(){
  panorama=new naver.maps.Panorama('roadview',{
    position:new naver.maps.LatLng(currentPos.lat,currentPos.lng),
    pov:{pan:heading,tilt:0,fov:100},
    logoControl:false,zoomControl:false,aroundControl:false,
  });
  // ì´ˆê¸°í™” ì™„ë£Œì‹œ í˜„ì¬ ì¹´ë©”ë¼ pov ë°©í–¥ì„ headingìœ¼ë¡œ ì‚¬ìš©
  naver.maps.Event.addListener(panorama,'init',function(){
    try {
      // í˜„ì¬ ë¡œë“œë·°ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ì„ ê·¸ëŒ€ë¡œ headingìœ¼ë¡œ ì„¤ì •
      const pov = panorama.getPov();
      if(pov) {
        heading = pov.pan;
      }
      // ë§í¬(ì „ì§„ ê°€ëŠ¥ ë°©í–¥) ì¤‘ í˜„ì¬ headingê³¼ ê°€ì¥ ê°€ê¹Œìš´ ë°©í–¥ìœ¼ë¡œ ë§ì¶¤
      const pano = panorama.getPanorama();
      if(pano && pano.links && pano.links.length > 0) {
        let bestPan = heading, bestDiff = 360;
        pano.links.forEach(link => {
          const pan = link.angle !== undefined ? link.angle : (link.pan || 0);
          let diff = Math.abs(((pan - heading) + 360) % 360);
          if(diff > 180) diff = 360 - diff;
          if(diff < bestDiff) { bestDiff = diff; bestPan = pan; }
        });
        heading = bestPan;
        panorama.setPov({pan: heading, tilt: 0, fov: 100});
      }
    } catch(e) {}
  });

  naver.maps.Event.addListener(panorama,'position_changed',function(){
    const pos=panorama.getPosition();
    if(pos){
      currentPos.lat=pos.lat(); currentPos.lng=pos.lng();
      document.getElementById('loc-name').textContent=
        `${currentPos.lat.toFixed(4)}Â°N, ${currentPos.lng.toFixed(4)}Â°E`;
    }
    // ìœ„ì¹˜ ë³€ê²½ í›„ ì¹´ë©”ë¼ ë°©í–¥ ê°•ì œ ìœ ì§€
    if(engineOn && !atIntersection) {
      setTimeout(()=>{ if(panorama) panorama.setPov({pan:heading,tilt:0,fov:100}); }, 100);
    }
  });
}

// â”€â”€ ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleEngine(){
  engineOn=!engineOn;
  const btn=document.getElementById('start-btn');
  const dot=document.getElementById('eng-dot');
  const lb=document.getElementById('left-btn');
  const rb=document.getElementById('right-btn');
  if(engineOn){
    btn.textContent='ì‹œë™ OFF'; btn.classList.add('running');
    dot.classList.add('on'); lb.disabled=false; rb.disabled=false;
    setStatus('â–¶ ì£¼í–‰ ì¤‘');
    startDriving();
  } else {
    btn.textContent='ì‹œë™ ON'; btn.classList.remove('running');
    dot.classList.remove('on'); lb.disabled=true; rb.disabled=true;
    setStatus('â–  ENGINE OFF');
    stopDriving();
    cancelIntersection();
  }
}

function startDriving(){
  if(driveTimer) clearInterval(driveTimer);
  driveTimer=setInterval(moveForward, DRIVE_INTERVAL);
}
function stopDriving(){
  clearInterval(driveTimer); driveTimer=null;
  resetWheel();
}

// â”€â”€ MOVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function moveForward(){
  if(atIntersection) return;
  const rad=heading*Math.PI/180;
  currentPos.lat+=MOVE_STEP*Math.cos(rad);
  currentPos.lng+=MOVE_STEP*Math.sin(rad);
  if(panorama){
    panorama.setPosition(new naver.maps.LatLng(currentPos.lat,currentPos.lng));
    // ì´ë™ í›„ ì¹´ë©”ë¼ë¥¼ ì§„í–‰ ë°©í–¥ìœ¼ë¡œ ê°•ì œ ê³ ì • (ë„¤ì´ë²„ ìë™íšŒì „ ë°©ì§€)
    setTimeout(() => {
      if(panorama) panorama.setPov({pan:heading, tilt:0, fov:100});
    }, 80);
    setTimeout(() => {
      if(panorama) panorama.setPov({pan:heading, tilt:0, fov:100});
    }, 200);
  }
  checkIntersection();
}

// â”€â”€ ê°ˆë¦¼ê¸¸ ê°ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkIntersection(){
  if(!panorama||!engineOn) return;
  try{
    const pano=panorama.getPanorama();
    if(!pano) return;
    const links=pano.links||[];
    if(links.length>=2) handleIntersection(links);
  }catch(e){}
}

function handleIntersection(links){
  if(atIntersection) return;
  atIntersection=true;
  intersectionLinks=links;
  setStatus('ğŸš¦ ê°ˆë¦¼ê¸¸ - í•¸ë“¤ë¡œ ë°©í–¥ ì„ íƒ!');

  const dirBtns=document.getElementById('dir-buttons');
  dirBtns.innerHTML='';

  const getRelDir=(pan)=>{
    let diff=((pan-heading)+360)%360;
    if(diff>180) diff-=360;
    if(diff<-60) return {label:'â† ì¢ŒíšŒì „',type:'left'};
    if(diff>60)  return {label:'â†’ ìš°íšŒì „',type:'right'};
    return {label:'â†‘ ì§ì§„',type:'straight'};
  };

  const seen=new Set();
  links.forEach(link=>{
    const pan=link.angle!==undefined?link.angle:(link.pan||0);
    const key=Math.round(pan/30);
    if(seen.has(key)) return;
    seen.add(key);
    const {label}=getRelDir(pan);
    const btn=document.createElement('button');
    btn.className='dir-choice-btn';
    btn.textContent=label;
    btn.onclick=()=>chooseDirection(pan);
    dirBtns.appendChild(btn);
  });

  if(dirBtns.children.length<=1){
    atIntersection=false;
    return;
  }

  showIntersectionPopup();

  // 0.5ì´ˆ í›„ ì§ì§„ ìë™ ì„ íƒ
  const bar=document.getElementById('countdown-bar');
  bar.style.transition='none'; bar.style.width='100%';
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      bar.style.transition=`width ${INTERSECTION_TIMEOUT}ms linear`;
      bar.style.width='0%';
    });
  });

  intersectionTimer=setTimeout(()=>{
    if(atIntersection) goStraight();
  }, INTERSECTION_TIMEOUT);
}

function goStraight(){
  // í˜„ì¬ headingê³¼ ê°€ì¥ ê°€ê¹Œìš´ ë§í¬ ì„ íƒ
  let bestPan=heading, bestDiff=360;
  intersectionLinks.forEach(link=>{
    const pan=link.angle!==undefined?link.angle:(link.pan||0);
    let diff=((pan-heading)+360)%360;
    if(diff>180) diff-=360;
    const absDiff=Math.abs(diff);
    if(absDiff<bestDiff){ bestDiff=absDiff; bestPan=pan; }
  });
  chooseDirection(bestPan);
}

function chooseDirection(pan){
  clearTimeout(intersectionTimer);
  heading=(pan+360)%360;
  atIntersection=false;
  hideIntersectionPopup();
  setStatus('â–¶ ì£¼í–‰ ì¤‘');
  if(panorama) panorama.setPov({pan:heading,tilt:0,fov:100});
  resetWheel();
  setTimeout(()=>{ if(engineOn&&!atIntersection) moveForward(); },300);
}

function cancelIntersection(){
  clearTimeout(intersectionTimer);
  atIntersection=false;
  hideIntersectionPopup();
}

function showIntersectionPopup(){ document.getElementById('intersection-popup').classList.add('show'); }
function hideIntersectionPopup(){ document.getElementById('intersection-popup').classList.remove('show'); }

// â”€â”€ í•¸ë“¤ ì¡°ì‘ (ê°ˆë¦¼ê¸¸ ì‹œ ë°©í–¥ ì„ íƒ ê²¸ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onLeftPress(){
  if(!engineOn) return;
  if(atIntersection){
    // ê°ˆë¦¼ê¸¸: ê°€ì¥ ì™¼ìª½ ë§í¬ ì„ íƒ
    let bestPan=heading, bestDiff=0;
    let found=false;
    intersectionLinks.forEach(link=>{
      const pan=link.angle!==undefined?link.angle:(link.pan||0);
      let diff=((pan-heading)+360)%360;
      if(diff>180) diff-=360;
      if(diff<-20&&(!found||diff<bestDiff)){ bestDiff=diff; bestPan=pan; found=true; }
    });
    chooseDirection(found?bestPan:heading-TURN_STEP);
    return;
  }
  doTurn('left');
  turnTimer=setInterval(()=>doTurn('left'),200);
}
function onLeftRelease(){
  clearInterval(turnTimer); turnTimer=null;
  if(!atIntersection) resetWheel();
}

function onRightPress(){
  if(!engineOn) return;
  if(atIntersection){
    // ê°ˆë¦¼ê¸¸: ê°€ì¥ ì˜¤ë¥¸ìª½ ë§í¬ ì„ íƒ
    let bestPan=heading, bestDiff=0;
    let found=false;
    intersectionLinks.forEach(link=>{
      const pan=link.angle!==undefined?link.angle:(link.pan||0);
      let diff=((pan-heading)+360)%360;
      if(diff>180) diff-=360;
      if(diff>20&&(!found||diff>bestDiff)){ bestDiff=diff; bestPan=pan; found=true; }
    });
    chooseDirection(found?bestPan:heading+TURN_STEP);
    return;
  }
  doTurn('right');
  turnTimer=setInterval(()=>doTurn('right'),200);
}
function onRightRelease(){
  clearInterval(turnTimer); turnTimer=null;
  if(!atIntersection) resetWheel();
}

function doTurn(dir){
  heading=(heading+(dir==='left'?-TURN_STEP:TURN_STEP)+360)%360;
  document.getElementById('steering-wheel').style.transform=
    `rotate(${dir==='left'?-38:38}deg)`;
  if(panorama) panorama.setPov({pan:heading,tilt:0,fov:100});
}
function resetWheel(){
  document.getElementById('steering-wheel').style.transform='rotate(0deg)';
}

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMap(){
  document.getElementById('map-modal').classList.add('show');
  if(!naverMap){
    setTimeout(()=>{
      try{
        naverMap=new naver.maps.Map('naver-map',{
          center:new naver.maps.LatLng(currentPos.lat,currentPos.lng),
          zoom:15,
          scaleControl:false,
          logoControl:false,
        });
        mapMarker=new naver.maps.Marker({
          position:new naver.maps.LatLng(currentPos.lat,currentPos.lng),map:naverMap,
        });
        naver.maps.Event.addListener(naverMap,'click',function(e){
          mapMarker.setPosition(e.coord);
          teleportTo(e.coord.lat(),e.coord.lng());
          closeMap();
        });
      }catch(e){ alert('ì§€ë„ ë¡œë”© ì‹¤íŒ¨: '+e.message); }
    },150);
  } else {
    setTimeout(()=>{
      naver.maps.Event.trigger(naverMap,'resize');
      naverMap.setCenter(new naver.maps.LatLng(currentPos.lat,currentPos.lng));
    },100);
  }
}
function closeMap(){ document.getElementById('map-modal').classList.remove('show'); }

function teleportTo(lat,lng){
  currentPos={lat,lng}; heading=0;
  cancelIntersection(); resetWheel();
  document.getElementById('loc-name').textContent=`${lat.toFixed(4)}Â°N, ${lng.toFixed(4)}Â°E`;
  if(panorama){
    panorama.setPosition(new naver.maps.LatLng(lat,lng));
    panorama.setPov({pan:0,tilt:0,fov:100});
  }
}

function setStatus(msg){ document.getElementById('status-bar').textContent=msg; }

// â”€â”€ í‚¤ë³´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',(e)=>{
  if(e.key==='ArrowLeft')  onLeftPress();
  if(e.key==='ArrowRight') onRightPress();
  if(e.key===' '){ e.preventDefault(); toggleEngine(); }
  if(e.key==='m'||e.key==='M') openMap();
  if(e.key==='h'||e.key==='H') playHorn();
});
document.addEventListener('keyup',(e)=>{
  if(e.key==='ArrowLeft')  onLeftRelease();
  if(e.key==='ArrowRight') onRightRelease();
});
</script>
</body>
</html>
